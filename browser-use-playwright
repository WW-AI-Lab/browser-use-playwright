#!/usr/bin/env python3
"""
Browser-Use-Playwright ä¸»å¯åŠ¨è„šæœ¬
æ”¯æŒCLIå‘½ä»¤ã€Web UIå¯åŠ¨ã€è™šæ‹Ÿç¯å¢ƒç®¡ç†
"""

import os
import sys
import subprocess
import argparse
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))
sys.path.insert(0, str(project_root / "src"))


def is_in_venv():
    """æ£€æŸ¥æ˜¯å¦åœ¨è™šæ‹Ÿç¯å¢ƒä¸­"""
    return (
        hasattr(sys, 'real_prefix') or
        (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix) or
        'VIRTUAL_ENV' in os.environ
    )


def find_venv_python():
    """æŸ¥æ‰¾è™šæ‹Ÿç¯å¢ƒä¸­çš„Pythonæ‰§è¡Œè·¯å¾„"""
    venv_paths = [
        project_root / ".venv",
        project_root / "venv",
        project_root / ".virtualenv"
    ]
    
    for venv_path in venv_paths:
        if venv_path.exists():
            # Windows
            python_exe = venv_path / "Scripts" / "python.exe"
            if python_exe.exists():
                return str(python_exe)
            
            # Unix/Linux/macOS
            python_exe = venv_path / "bin" / "python"
            if python_exe.exists():
                return str(python_exe)
    
    return None


def activate_venv_and_run(args):
    """æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶è¿è¡Œå‘½ä»¤"""
    venv_python = find_venv_python()
    
    if venv_python:
        print(f"ğŸ” å‘ç°è™šæ‹Ÿç¯å¢ƒ: {venv_python}")
        print(f"ğŸš€ ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒè¿è¡Œ: {' '.join(args)}")
        
        # ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒçš„Pythoné‡æ–°è¿è¡Œè„šæœ¬
        cmd = [venv_python, __file__] + args
        return subprocess.run(cmd, env=os.environ.copy())
    else:
        print("âš ï¸  æœªæ‰¾åˆ°è™šæ‹Ÿç¯å¢ƒ(.venv, venv, .virtualenv)")
        print("ğŸ’¡ å»ºè®®åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ: python -m venv .venv")
        return None


def create_venv():
    """åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ"""
    venv_path = project_root / ".venv"
    
    if venv_path.exists():
        print(f"âœ… è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨: {venv_path}")
        return True
    
    print(f"ğŸ—ï¸  åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ: {venv_path}")
    try:
        subprocess.run([sys.executable, "-m", "venv", str(venv_path)], check=True)
        print("âœ… è™šæ‹Ÿç¯å¢ƒåˆ›å»ºæˆåŠŸ")
        
        # å‡çº§pip
        venv_python = find_venv_python()
        if venv_python:
            print("ğŸ“¦ å‡çº§pip...")
            subprocess.run([venv_python, "-m", "pip", "install", "--upgrade", "pip"], check=True)
            
            # å®‰è£…ä¾èµ–
            requirements_file = project_root / "requirements.txt"
            if requirements_file.exists():
                print("ğŸ“‹ å®‰è£…é¡¹ç›®ä¾èµ–...")
                subprocess.run([venv_python, "-m", "pip", "install", "-r", str(requirements_file)], check=True)
        
        return True
    except subprocess.CalledProcessError as e:
        print(f"âŒ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¤±è´¥: {e}")
        return False


def start_web_ui():
    """å¯åŠ¨Web UI"""
    print("ğŸŒ å¯åŠ¨Browser-Use-Playwright Web UI...")
    print("ğŸ“ åœ°å€: http://127.0.0.1:8000")
    print("â¹ï¸  æŒ‰ Ctrl+C åœæ­¢æœåŠ¡")
    
    try:
        # å¯¼å…¥å¹¶å¯åŠ¨Webåº”ç”¨
        from src.web.app import app
        import uvicorn
        uvicorn.run(app, host="0.0.0.0", port=8000)
    except KeyboardInterrupt:
        print("\nğŸ›‘ Web UIå·²åœæ­¢")
    except Exception as e:
        print(f"âŒ å¯åŠ¨Web UIå¤±è´¥: {e}")
        sys.exit(1)


def main():
    """ä¸»å…¥å£å‡½æ•°"""
    parser = argparse.ArgumentParser(
        description="Browser-Use-Playwright - Browser-Use + Playwright RPAè‡ªåŠ¨åŒ–æ¡†æ¶",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ç¤ºä¾‹:
  ./browser-use-playwright                    # å¯åŠ¨Web UIç•Œé¢
  ./browser-use-playwright web               # å¯åŠ¨Web UIç•Œé¢  
  ./browser-use-playwright cli               # å¯åŠ¨CLIæ¨¡å¼
  ./browser-use-playwright record            # å½•åˆ¶å·¥ä½œæµ
  ./browser-use-playwright run workflow.json # æ‰§è¡Œå·¥ä½œæµ
  ./browser-use-playwright create-venv       # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
  ./browser-use-playwright --help           # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

è™šæ‹Ÿç¯å¢ƒç®¡ç†:
  å¦‚æœä¸åœ¨è™šæ‹Ÿç¯å¢ƒä¸­ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ(.venv, venv, .virtualenv)
        """
    )
    
    parser.add_argument(
        "command", 
        nargs="?", 
        default="web",
        choices=["web", "cli", "record", "run", "list", "show", "clean", "heal", "batch", "create-venv", "version"],
        help="è¦æ‰§è¡Œçš„å‘½ä»¤ (é»˜è®¤: web)"
    )
    
    parser.add_argument(
        "args", 
        nargs="*", 
        help="ä¼ é€’ç»™CLIçš„é¢å¤–å‚æ•°"
    )
    
    parser.add_argument(
        "--force-venv", 
        action="store_true",
        help="å¼ºåˆ¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ"
    )
    
    # è§£æå‚æ•°
    parsed_args, unknown_args = parser.parse_known_args()
    all_cli_args = parsed_args.args + unknown_args
    
    # æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
    if not is_in_venv() and not parsed_args.command == "create-venv":
        if parsed_args.force_venv or find_venv_python():
            # å°è¯•æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶é‡æ–°è¿è¡Œ
            result = activate_venv_and_run(sys.argv[1:])
            if result:
                sys.exit(result.returncode)
        else:
            print("âš ï¸  å½“å‰ä¸åœ¨è™šæ‹Ÿç¯å¢ƒä¸­")
            print("ğŸ’¡ å»ºè®®è¿è¡Œ: ./browser-use-playwright create-venv åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ")
            print("ğŸ”„ æˆ–æ·»åŠ  --force-venv å‚æ•°å¼ºåˆ¶è¿è¡Œ")
    
    # å¤„ç†å‘½ä»¤
    if parsed_args.command == "web":
        start_web_ui()
    
    elif parsed_args.command == "create-venv":
        if create_venv():
            print("ğŸ‰ è™šæ‹Ÿç¯å¢ƒè®¾ç½®å®Œæˆï¼")
            print("ğŸ’¡ ç°åœ¨å¯ä»¥è¿è¡Œ: ./browser-use-playwright web å¯åŠ¨Web UI")
        else:
            sys.exit(1)
    
    elif parsed_args.command == "cli":
        # å¯åŠ¨CLIäº¤äº’æ¨¡å¼
        try:
            from src.cli.main import main as cli_main
            cli_main()
        except Exception as e:
            print(f"âŒ å¯åŠ¨CLIå¤±è´¥: {e}")
            sys.exit(1)
    
    else:
        # å…¶ä»–å‘½ä»¤ç›´æ¥ä¼ é€’ç»™CLI
        try:
            from src.cli.main import app
            import typer
            
            # æ„é€ CLIå‘½ä»¤å‚æ•°
            cli_args = [parsed_args.command] + all_cli_args
            
            # ä½¿ç”¨typerè¿è¡ŒCLIå‘½ä»¤
            app(cli_args, standalone_mode=False)
            
        except SystemExit as e:
            # typerä¼šæŠ›å‡ºSystemExitï¼Œè¿™æ˜¯æ­£å¸¸çš„
            sys.exit(e.code)
        except Exception as e:
            print(f"âŒ æ‰§è¡Œå‘½ä»¤å¤±è´¥: {e}")
            sys.exit(1)


if __name__ == "__main__":
    main() 