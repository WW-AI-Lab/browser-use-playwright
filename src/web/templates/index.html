{% extends "base.html" %}

{% block title %}å·¥ä½œæµç®¡ç† - Browser-use-Playwright{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>å·¥ä½œæµç®¡ç†</h1>
    <div class="btn-group">
        <button class="btn btn-primary" onclick="showRecordingModal()">
            <i class="bi bi-magic"></i> å½•åˆ¶
        </button>
        <button class="btn btn-success" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
        </button>
    </div>
</div>

{% if workflows %}
<div class="row">
    {% for workflow in workflows %}
    <div class="col-md-6 col-lg-4 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">{{ workflow.name }}</h5>
                <p class="card-text">{{ workflow.description or "æ— æè¿°" }}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="bi bi-list-ol"></i> {{ workflow.steps_count }} æ­¥éª¤
                    </small>
                    <div class="btn-group" role="group">
                        <button class="btn btn-success btn-sm" onclick="runWorkflow('{{ workflow.name }}')">
                            <i class="bi bi-play-fill"></i> è¿è¡Œ
                        </button>
                        <a href="/workflows/{{ workflow.name }}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye"></i> æŸ¥çœ‹
                        </a>
                        <a href="/workflows/{{ workflow.name }}/edit" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-pencil"></i> ç¼–è¾‘
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="bi bi-folder2-open display-1 text-muted"></i>
    <h3 class="mt-3">æ²¡æœ‰æ‰¾åˆ°å·¥ä½œæµ</h3>
    <p class="text-muted">è¯·å…ˆå½•åˆ¶ä¸€äº›å·¥ä½œæµ</p>
</div>
{% endif %}

<!-- æ‰§è¡ŒçŠ¶æ€æ¨¡æ€æ¡† -->
<div class="modal fade" id="executionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€</h5>
                <button type="button" class="btn-close" onclick="closeModal()" title="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <div id="executionStatus">
                    <div class="text-center">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2">æ­£åœ¨æ‰§è¡Œå·¥ä½œæµ...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
                <button type="button" class="btn btn-danger" id="cancelBtn" onclick="cancelExecution()">åœæ­¢æ‰§è¡Œ</button>
            </div>
        </div>
    </div>
</div>

<!-- å½•åˆ¶é…ç½®æ¨¡æ€æ¡† -->
<div class="modal fade" id="recordingModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å½•åˆ¶æ–°å·¥ä½œæµ</h5>
                <button type="button" class="btn-close" onclick="closeRecordingModal()" title="å…³é—­"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="recordingForm">
                    <div class="mb-3">
                        <label for="workflowName" class="form-label">å·¥ä½œæµåç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="workflowName" name="name" required 
                               placeholder="ä¾‹å¦‚ï¼šgoogle_search_books">
                        <div class="form-text">åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="workflowDescription" class="form-label">å·¥ä½œæµæè¿°</label>
                        <input type="text" class="form-control" id="workflowDescription" name="description"
                               placeholder="ä¾‹å¦‚ï¼šåœ¨Googleæœç´¢æŒ‡å®šçš„ä¹¦ç±">
                    </div>
                    
                    <div class="mb-3">
                        <label for="recordingMode" class="form-label">å½•åˆ¶æ¨¡å¼ <span class="text-danger">*</span></label>
                        <select class="form-select" id="recordingMode" name="mode" required onchange="toggleModeFields()">
                            <option value="guided">å¼•å¯¼å¼å½•åˆ¶ï¼ˆAIè‡ªåŠ¨æ‰§è¡Œï¼‰</option>
                            <option value="interactive">äº¤äº’å¼å½•åˆ¶ï¼ˆæ‰‹åŠ¨æ“ä½œï¼‰</option>
                        </select>
                        <div class="form-text">
                            <strong>å¼•å¯¼å¼</strong>ï¼šæè¿°ä»»åŠ¡ï¼ŒAIè‡ªåŠ¨æ‰§è¡Œå¹¶å½•åˆ¶<br>
                            <strong>äº¤äº’å¼</strong>ï¼šæ‰‹åŠ¨åœ¨æµè§ˆå™¨ä¸­æ“ä½œï¼Œç³»ç»Ÿè‡ªåŠ¨è®°å½•
                        </div>
                    </div>
                    
                    <div class="mb-3" id="taskDescriptionGroup">
                        <label for="taskDescription" class="form-label">ä»»åŠ¡æè¿° <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="taskDescription" name="task_description" rows="3" 
                                  placeholder="ä¾‹å¦‚ï¼šåœ¨Googleæœç´¢'Pythonç¼–ç¨‹'ï¼Œç„¶åç‚¹å‡»ç¬¬ä¸€ä¸ªæœç´¢ç»“æœ"></textarea>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="form-text">è¯¦ç»†æè¿°ä½ å¸Œæœ›AIæ‰§è¡Œçš„æ“ä½œæ­¥éª¤</div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="optimizeTask()" id="optimizeBtn">
                                <i class="bi bi-lightbulb"></i> ä¼˜åŒ–ä»»åŠ¡
                            </button>
                        </div>
                        
                        <!-- ä¼˜åŒ–ç»“æœå±•ç¤ºåŒºåŸŸ -->
                        <div id="optimizationResult" class="mt-3" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-light py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold text-success">
                                            <i class="bi bi-check-circle"></i> ä»»åŠ¡å·²ä¼˜åŒ–
                                        </span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="revertOptimization()">
                                            æ’¤é”€
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body py-2">
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <strong class="small">ä¼˜åŒ–åçš„ä»»åŠ¡ï¼š</strong>
                                            <small class="text-muted">è€—æ—¶ <span id="optimizationTime">-</span>ç§’</small>
                                        </div>
                                        <div id="optimizedTaskText" class="p-2 bg-light border rounded small" style="max-height: 100px; overflow-y: auto;"></div>
                                    </div>
                                    <div class="mb-0">
                                        <strong class="small">æ”¹è¿›ç‚¹ï¼š</strong>
                                        <ul id="improvementsList" class="small mb-0 mt-1"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoOptimize" name="auto_optimize" checked>
                            <label class="form-check-label" for="autoOptimize">
                                è‡ªåŠ¨ä¼˜åŒ–ä»»åŠ¡æè¿°ï¼ˆæ¨èï¼‰
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="headlessMode" name="headless">
                            <label class="form-check-label" for="headlessMode">
                                æ— å¤´æ¨¡å¼ï¼ˆåå°è¿è¡Œï¼Œä¸æ˜¾ç¤ºæµè§ˆå™¨çª—å£ï¼‰
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRecordingModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="startRecording()">
                    <i class="bi bi-magic"></i> å¼€å§‹å½•åˆ¶
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å½•åˆ¶çŠ¶æ€æ¨¡æ€æ¡† -->
<div class="modal fade" id="recordingStatusModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å½•åˆ¶çŠ¶æ€</h5>
                <button type="button" class="btn-close" onclick="closeRecordingStatusModal()" title="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <div id="recordingStatus">
                    <div class="text-center">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2">æ­£åœ¨å¯åŠ¨å½•åˆ¶...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRecordingStatusModal()">å…³é—­</button>
                <button type="button" class="btn btn-danger" id="stopRecordingBtn" onclick="stopRecording()">åœæ­¢å½•åˆ¶</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTaskId = null;
let currentRecordingTaskId = null;

// è¿è¡Œå·¥ä½œæµ
async function runWorkflow(workflowName) {
    try {
        console.log('å¼€å§‹è¿è¡Œå·¥ä½œæµ:', workflowName);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        showModal();
        resetStatus();
        
        // æäº¤æ‰§è¡Œè¯·æ±‚
        const response = await fetch(`/api/workflows/${workflowName}/execute`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                variables: {},
                headless: false,
                timeout: 60
            })
        });
        
        if (!response.ok) {
            throw new Error(`æ‰§è¡Œè¯·æ±‚å¤±è´¥: ${response.statusText}`);
        }
        
        const result = await response.json();
        currentTaskId = result.task_id;
        console.log('ä»»åŠ¡å·²æäº¤ï¼ŒID:', currentTaskId);
        
        // å¼€å§‹è½®è¯¢çŠ¶æ€
        pollStatus(currentTaskId);
        
    } catch (error) {
        console.error('æ‰§è¡Œå·¥ä½œæµå¤±è´¥:', error);
        showError(`æ‰§è¡Œå¤±è´¥: ${error.message}`);
    }
}

// è½®è¯¢æ‰§è¡ŒçŠ¶æ€
async function pollStatus(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}/status`);
        if (!response.ok) {
            throw new Error('è·å–çŠ¶æ€å¤±è´¥');
        }
        
        const statusData = await response.json();
        console.log('ä»»åŠ¡çŠ¶æ€:', statusData);
        
        updateStatus(statusData);
        
        if (statusData.status === 'running') {
            setTimeout(() => pollStatus(taskId), 2000);
        } else {
            showResult(statusData);
        }
        
    } catch (error) {
        console.error('è·å–æ‰§è¡ŒçŠ¶æ€å¤±è´¥:', error);
        showError(`è·å–çŠ¶æ€å¤±è´¥: ${error.message}`);
    }
}

// æ˜¾ç¤ºæ¨¡æ€æ¡†
function showModal() {
    const modalEl = document.getElementById('executionModal');
    modalEl.style.display = 'block';
    modalEl.classList.add('show');
    document.body.classList.add('modal-open');
    
    // åˆ›å»ºèƒŒæ™¯
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.id = 'modal-backdrop';
    document.body.appendChild(backdrop);
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal() {
    const modalEl = document.getElementById('executionModal');
    modalEl.style.display = 'none';
    modalEl.classList.remove('show');
    document.body.classList.remove('modal-open');
    
    const backdrop = document.getElementById('modal-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
}

// é‡ç½®çŠ¶æ€
function resetStatus() {
    const statusDiv = document.getElementById('executionStatus');
    const cancelBtn = document.getElementById('cancelBtn');
    
    cancelBtn.style.display = 'inline-block';
    currentTaskId = null;
    
    statusDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">æ­£åœ¨å¯åŠ¨æ‰§è¡Œ...</p>
        </div>
    `;
}

// æ›´æ–°çŠ¶æ€
function updateStatus(statusData) {
    const statusDiv = document.getElementById('executionStatus');
    
    if (statusData.status === 'running') {
        const progress = statusData.progress || {};
        const progressPercent = progress.completed_steps && progress.total_steps ? 
            Math.round((progress.completed_steps / progress.total_steps) * 100) : 0;
        
        statusDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">æ­£åœ¨æ‰§è¡Œå·¥ä½œæµ... ${progressPercent}%</p>
                ${progress.total_steps ? `<p class="text-muted">è¿›åº¦: ${progress.completed_steps || 0}/${progress.total_steps} æ­¥éª¤</p>` : ''}
            </div>
        `;
    }
}

// æ˜¾ç¤ºç»“æœ
function showResult(statusData) {
    const statusDiv = document.getElementById('executionStatus');
    const cancelBtn = document.getElementById('cancelBtn');
    
    cancelBtn.style.display = 'none';
    
    if (statusData.status === 'completed') {
        const result = statusData.result || {};
        const successRate = result.success_rate || 0;
        
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <h6>âœ… æ‰§è¡Œå®Œæˆ</h6>
                <p>å·¥ä½œæµæ‰§è¡ŒæˆåŠŸå®Œæˆ</p>
                <p><strong>æˆåŠŸç‡:</strong> ${(successRate * 100).toFixed(1)}%</p>
                <p><strong>æ€»æ­¥éª¤:</strong> ${result.total_steps || 0}</p>
            </div>
        `;
    } else if (statusData.status === 'failed') {
        const result = statusData.result || {};
        
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>âš ï¸ æ‰§è¡Œå¤±è´¥</h6>
                <p>${result.error_message || 'æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯'}</p>
            </div>
        `;
    }
}

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
    const statusDiv = document.getElementById('executionStatus');
    statusDiv.innerHTML = `
        <div class="alert alert-danger">
            <p>${message}</p>
        </div>
    `;
}

// å–æ¶ˆæ‰§è¡Œ
async function cancelExecution() {
    if (!currentTaskId) return;
    
    try {
        const response = await fetch(`/api/tasks/${currentTaskId}/cancel`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showError('æ­£åœ¨å–æ¶ˆæ‰§è¡Œ...');
        }
    } catch (error) {
        console.error('å–æ¶ˆæ‰§è¡Œå¤±è´¥:', error);
    }
}

// ============ å½•åˆ¶åŠŸèƒ½ ============

// æ˜¾ç¤ºå½•åˆ¶é…ç½®æ¨¡æ€æ¡†
function showRecordingModal() {
    const modalEl = document.getElementById('recordingModal');
    modalEl.style.display = 'block';
    modalEl.classList.add('show');
    document.body.classList.add('modal-open');
    
    // åˆ›å»ºèƒŒæ™¯
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.id = 'recording-modal-backdrop';
    document.body.appendChild(backdrop);
    
    // é‡ç½®è¡¨å•
    document.getElementById('recordingForm').reset();
    toggleModeFields();
}

// å…³é—­å½•åˆ¶é…ç½®æ¨¡æ€æ¡†
function closeRecordingModal() {
    const modalEl = document.getElementById('recordingModal');
    modalEl.style.display = 'none';
    modalEl.classList.remove('show');
    document.body.classList.remove('modal-open');
    
    const backdrop = document.getElementById('recording-modal-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
}

// åˆ‡æ¢å½•åˆ¶æ¨¡å¼å­—æ®µæ˜¾ç¤º
function toggleModeFields() {
    const mode = document.getElementById('recordingMode').value;
    const taskDescriptionGroup = document.getElementById('taskDescriptionGroup');
    const taskDescriptionInput = document.getElementById('taskDescription');
    
    if (mode === 'guided') {
        taskDescriptionGroup.style.display = 'block';
        taskDescriptionInput.required = true;
    } else {
        taskDescriptionGroup.style.display = 'none';
        taskDescriptionInput.required = false;
    }
}



// æ˜¾ç¤ºå½•åˆ¶çŠ¶æ€æ¨¡æ€æ¡†
function showRecordingStatusModal() {
    const modalEl = document.getElementById('recordingStatusModal');
    modalEl.style.display = 'block';
    modalEl.classList.add('show');
    document.body.classList.add('modal-open');
    
    // åˆ›å»ºèƒŒæ™¯
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.id = 'recording-status-modal-backdrop';
    document.body.appendChild(backdrop);
    
    // é‡ç½®çŠ¶æ€
    resetRecordingStatus();
}

// å…³é—­å½•åˆ¶çŠ¶æ€æ¨¡æ€æ¡†
function closeRecordingStatusModal() {
    const modalEl = document.getElementById('recordingStatusModal');
    modalEl.style.display = 'none';
    modalEl.classList.remove('show');
    document.body.classList.remove('modal-open');
    
    const backdrop = document.getElementById('recording-status-modal-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
}

// é‡ç½®å½•åˆ¶çŠ¶æ€
function resetRecordingStatus() {
    const statusDiv = document.getElementById('recordingStatus');
    const stopBtn = document.getElementById('stopRecordingBtn');
    
    stopBtn.style.display = 'inline-block';
    
    statusDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">æ­£åœ¨å¯åŠ¨å½•åˆ¶...</p>
        </div>
    `;
}

// è½®è¯¢å½•åˆ¶çŠ¶æ€
async function pollRecordingStatus(taskId) {
    try {
        const response = await fetch(`/api/recording/${taskId}/status`);
        if (!response.ok) {
            throw new Error('è·å–å½•åˆ¶çŠ¶æ€å¤±è´¥');
        }
        
        const statusData = await response.json();
        console.log('å½•åˆ¶çŠ¶æ€:', statusData);
        
        updateRecordingStatus(statusData);
        
        // å¦‚æœè¿˜åœ¨å½•åˆ¶ä¸­ï¼Œç»§ç»­è½®è¯¢
        if (statusData.status === 'recording' || statusData.status === 'starting') {
            setTimeout(() => pollRecordingStatus(taskId), 2000);
        } else {
            showRecordingResult(statusData);
        }
        
    } catch (error) {
        console.error('è·å–å½•åˆ¶çŠ¶æ€å¤±è´¥:', error);
        showRecordingError(`è·å–å½•åˆ¶çŠ¶æ€å¤±è´¥: ${error.message}`);
    }
}

// æ›´æ–°å½•åˆ¶çŠ¶æ€
function updateRecordingStatus(statusData) {
    const statusDiv = document.getElementById('recordingStatus');
    
    if (statusData.status === 'starting') {
        statusDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">æ­£åœ¨å¯åŠ¨å½•åˆ¶...</p>
                <p class="text-muted">æ¨¡å¼: ${statusData.mode === 'guided' ? 'å¼•å¯¼å¼' : 'äº¤äº’å¼'}</p>
            </div>
        `;
    } else if (statusData.status === 'recording') {
        const startTime = new Date(statusData.start_time * 1000);
        const elapsed = Math.round((Date.now() - startTime.getTime()) / 1000);
        
        statusDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-success"></div>
                <p class="mt-2">ğŸ¬ æ­£åœ¨å½•åˆ¶å·¥ä½œæµ...</p>
                <p class="text-muted">å·¥ä½œæµ: ${statusData.name}</p>
                <p class="text-muted">å·²å½•åˆ¶: ${elapsed}ç§’</p>
                ${statusData.mode === 'interactive' ? 
                    '<div class="alert alert-info mt-3"><small>ğŸ’¡ è¯·åœ¨æ‰“å¼€çš„æµè§ˆå™¨ä¸­è¿›è¡Œæ“ä½œï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•æ‚¨çš„æ“ä½œ</small></div>' : 
                    '<div class="alert alert-info mt-3"><small>ğŸ¤– AIæ­£åœ¨è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡å¹¶å½•åˆ¶æ“ä½œæ­¥éª¤</small></div>'
                }
            </div>
        `;
    }
}

// æ˜¾ç¤ºå½•åˆ¶ç»“æœ
function showRecordingResult(statusData) {
    const statusDiv = document.getElementById('recordingStatus');
    const stopBtn = document.getElementById('stopRecordingBtn');
    
    stopBtn.style.display = 'none';
    
    if (statusData.status === 'completed' && statusData.workflow) {
        const workflow = statusData.workflow;
        
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <h6>âœ… å½•åˆ¶å®Œæˆ</h6>
                <p>å·¥ä½œæµå½•åˆ¶æˆåŠŸå®Œæˆ</p>
                <p><strong>å·¥ä½œæµåç§°:</strong> ${workflow.name}</p>
                <p><strong>æ­¥éª¤æ•°é‡:</strong> ${workflow.steps_count}</p>
                <div class="mt-3">
                    <button class="btn btn-primary btn-sm" onclick="editWorkflow('${workflow.name}')">
                        <i class="bi bi-pencil"></i> ç¼–è¾‘å·¥ä½œæµ
                    </button>
                    <button class="btn btn-secondary btn-sm ms-2" onclick="closeRecordingStatusModal(); location.reload();">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°åˆ—è¡¨
                    </button>
                </div>
            </div>
        `;
    } else if (statusData.status === 'failed') {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>âš ï¸ å½•åˆ¶å¤±è´¥</h6>
                <p>${statusData.error || 'å½•åˆ¶è¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯'}</p>
                <div class="mt-3">
                    <button class="btn btn-secondary btn-sm" onclick="closeRecordingStatusModal()">
                        <i class="bi bi-arrow-left"></i> è¿”å›
                    </button>
                </div>
            </div>
        `;
    }
}

// æ˜¾ç¤ºå½•åˆ¶é”™è¯¯
function showRecordingError(message) {
    const statusDiv = document.getElementById('recordingStatus');
    const stopBtn = document.getElementById('stopRecordingBtn');
    
    stopBtn.style.display = 'none';
    
    statusDiv.innerHTML = `
        <div class="alert alert-danger">
            <h6>âŒ é”™è¯¯</h6>
            <p>${message}</p>
        </div>
    `;
}

// åœæ­¢å½•åˆ¶
async function stopRecording() {
    if (!currentRecordingTaskId) return;
    
    try {
        const response = await fetch(`/api/recording/${currentRecordingTaskId}/stop`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showRecordingError('æ­£åœ¨åœæ­¢å½•åˆ¶...');
        }
    } catch (error) {
        console.error('åœæ­¢å½•åˆ¶å¤±è´¥:', error);
        showRecordingError(`åœæ­¢å½•åˆ¶å¤±è´¥: ${error.message}`);
    }
}

// ç¼–è¾‘å·¥ä½œæµï¼ˆè·³è½¬åˆ°ç¼–è¾‘é¡µé¢ï¼‰
function editWorkflow(workflowName) {
    window.location.href = `/workflows/${workflowName}/edit`;
}

// ============ ä»»åŠ¡ä¼˜åŒ–åŠŸèƒ½ ============

let originalTaskDescription = '';  // ä¿å­˜åŸå§‹ä»»åŠ¡æè¿°
let isTaskOptimized = false;       // æ ‡è®°ä»»åŠ¡æ˜¯å¦å·²ä¼˜åŒ–

// ä¼˜åŒ–ä»»åŠ¡æè¿°
async function optimizeTask() {
    const taskTextarea = document.getElementById('taskDescription');
    const optimizeBtn = document.getElementById('optimizeBtn');
    const taskDescription = taskTextarea.value.trim();
    
    if (!taskDescription) {
        alert('è¯·å…ˆè¾“å…¥ä»»åŠ¡æè¿°');
        return;
    }
    
    if (taskDescription.length < 10) {
        alert('ä»»åŠ¡æè¿°è¿‡çŸ­ï¼Œè¯·æä¾›æ›´è¯¦ç»†çš„æè¿°');
        return;
    }
    
    try {
        // ä¿å­˜åŸå§‹ä»»åŠ¡æè¿°
        if (!isTaskOptimized) {
            originalTaskDescription = taskDescription;
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        optimizeBtn.disabled = true;
        optimizeBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ä¼˜åŒ–ä¸­...';
        
        console.log('å¼€å§‹ä¼˜åŒ–ä»»åŠ¡æè¿°:', taskDescription);
        
        // è°ƒç”¨ä¼˜åŒ–API
        const response = await fetch('/api/tasks/optimize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                task_description: taskDescription,
                language: 'zh'
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'ä»»åŠ¡ä¼˜åŒ–å¤±è´¥');
        }
        
        const result = await response.json();
        console.log('ä¼˜åŒ–ç»“æœ:', result);
        
        if (result.success) {
            // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
            showOptimizationResult(result);
            
            // æ›´æ–°ä»»åŠ¡æè¿°
            taskTextarea.value = result.optimized_task;
            isTaskOptimized = true;
            
            // æ›´æ–°æŒ‰é’®
            optimizeBtn.innerHTML = '<i class="bi bi-check-circle"></i> å·²ä¼˜åŒ–';
            optimizeBtn.disabled = false;
            optimizeBtn.classList.remove('btn-outline-primary');
            optimizeBtn.classList.add('btn-outline-success');
            
        } else {
            throw new Error(result.error_message || 'ä¼˜åŒ–å¤±è´¥');
        }
        
    } catch (error) {
        console.error('ä»»åŠ¡ä¼˜åŒ–å¤±è´¥:', error);
        alert(`ä»»åŠ¡ä¼˜åŒ–å¤±è´¥: ${error.message}`);
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        optimizeBtn.disabled = false;
        optimizeBtn.innerHTML = '<i class="bi bi-lightbulb"></i> ä¼˜åŒ–ä»»åŠ¡';
    }
}

// æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
function showOptimizationResult(result) {
    const resultDiv = document.getElementById('optimizationResult');
    const optimizedTaskText = document.getElementById('optimizedTaskText');
    const improvementsList = document.getElementById('improvementsList');
    const optimizationTime = document.getElementById('optimizationTime');
    
    // æ˜¾ç¤ºä¼˜åŒ–åçš„ä»»åŠ¡
    optimizedTaskText.textContent = result.optimized_task;
    
    // æ˜¾ç¤ºæ”¹è¿›ç‚¹
    improvementsList.innerHTML = '';
    result.improvements.forEach(improvement => {
        const li = document.createElement('li');
        li.textContent = improvement;
        improvementsList.appendChild(li);
    });
    
    // æ˜¾ç¤ºä¼˜åŒ–æ—¶é—´
    optimizationTime.textContent = result.optimization_time;
    
    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    resultDiv.style.display = 'block';
}

// æ’¤é”€ä¼˜åŒ–
function revertOptimization() {
    if (!isTaskOptimized || !originalTaskDescription) {
        return;
    }
    
    const taskTextarea = document.getElementById('taskDescription');
    const optimizeBtn = document.getElementById('optimizeBtn');
    const resultDiv = document.getElementById('optimizationResult');
    
    // æ¢å¤åŸå§‹ä»»åŠ¡æè¿°
    taskTextarea.value = originalTaskDescription;
    
    // éšè—ä¼˜åŒ–ç»“æœ
    resultDiv.style.display = 'none';
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    optimizeBtn.innerHTML = '<i class="bi bi-lightbulb"></i> ä¼˜åŒ–ä»»åŠ¡';
    optimizeBtn.disabled = false;
    optimizeBtn.classList.remove('btn-outline-success');
    optimizeBtn.classList.add('btn-outline-primary');
    
    // é‡ç½®æ ‡è®°
    isTaskOptimized = false;
    originalTaskDescription = '';
    
    console.log('å·²æ’¤é”€ä»»åŠ¡ä¼˜åŒ–');
}

// ä¿®æ”¹å¼€å§‹å½•åˆ¶å‡½æ•°ï¼ŒåŒ…å«è‡ªåŠ¨ä¼˜åŒ–é€‰é¡¹
async function startRecording() {
    try {
        // è·å–è¡¨å•æ•°æ®
        const form = document.getElementById('recordingForm');
        const formData = new FormData(form);
        
        // éªŒè¯å¿…å¡«å­—æ®µ
        const name = formData.get('name');
        const mode = formData.get('mode');
        
        if (!name || !name.trim()) {
            alert('è¯·è¾“å…¥å·¥ä½œæµåç§°');
            return;
        }
        
        // éªŒè¯å·¥ä½œæµåç§°æ ¼å¼
        if (!/^[a-zA-Z0-9_]+$/.test(name)) {
            alert('å·¥ä½œæµåç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
            return;
        }
        
        if (mode === 'guided') {
            const taskDescription = formData.get('task_description');
            if (!taskDescription || !taskDescription.trim()) {
                alert('å¼•å¯¼å¼å½•åˆ¶éœ€è¦å¡«å†™ä»»åŠ¡æè¿°');
                return;
            }
        }
        
        // æ„å»ºè¯·æ±‚æ•°æ®
        const requestData = {
            name: name.trim(),
            description: formData.get('description') || '',
            task_description: formData.get('task_description') || '',
            mode: mode,
            headless: formData.has('headless'),
            auto_optimize: formData.has('auto_optimize')  // æ·»åŠ è‡ªåŠ¨ä¼˜åŒ–é€‰é¡¹
        };
        
        console.log('å¼€å§‹å½•åˆ¶:', requestData);
        
        // å…³é—­é…ç½®æ¨¡æ€æ¡†
        closeRecordingModal();
        
        // æ˜¾ç¤ºå½•åˆ¶çŠ¶æ€æ¨¡æ€æ¡†
        showRecordingStatusModal();
        
        // å‘é€å½•åˆ¶è¯·æ±‚
        const response = await fetch('/api/recording/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'å¯åŠ¨å½•åˆ¶å¤±è´¥');
        }
        
        const result = await response.json();
        currentRecordingTaskId = result.task_id;
        
        console.log('å½•åˆ¶ä»»åŠ¡å·²å¯åŠ¨:', result);
        
        // å¦‚æœæœ‰ä¼˜åŒ–ä¿¡æ¯ï¼Œæ˜¾ç¤ºåœ¨çŠ¶æ€ä¸­
        if (result.optimization && result.optimization.applied) {
            console.log('ä»»åŠ¡å·²è‡ªåŠ¨ä¼˜åŒ–:', result.optimization);
        }
        
        // å¼€å§‹è½®è¯¢å½•åˆ¶çŠ¶æ€
        pollRecordingStatus(currentRecordingTaskId);
        
    } catch (error) {
        console.error('å¯åŠ¨å½•åˆ¶å¤±è´¥:', error);
        showRecordingError(`å¯åŠ¨å½•åˆ¶å¤±è´¥: ${error.message}`);
    }
}

// ä¿®æ”¹åˆ‡æ¢å½•åˆ¶æ¨¡å¼å­—æ®µæ˜¾ç¤º
function toggleModeFields() {
    const mode = document.getElementById('recordingMode').value;
    const taskDescriptionGroup = document.getElementById('taskDescriptionGroup');
    const taskDescriptionInput = document.getElementById('taskDescription');
    const autoOptimizeCheckbox = document.getElementById('autoOptimize');
    
    if (mode === 'guided') {
        taskDescriptionGroup.style.display = 'block';
        taskDescriptionInput.required = true;
        autoOptimizeCheckbox.closest('.form-check').style.display = 'block';
    } else {
        taskDescriptionGroup.style.display = 'none';
        taskDescriptionInput.required = false;
        autoOptimizeCheckbox.closest('.form-check').style.display = 'none';
    }
}
</script>
{% endblock %}