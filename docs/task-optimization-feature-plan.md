# Browser-Use 任务优化器功能规划文档

## 需求分析与目标拆解

### 核心需求
1. **任务描述优化**：集成Azure OpenAI，基于用户提供的system提示词优化用户输入的任务描述
2. **录制流程集成**：在UI录制流程中自动调用优化逻辑，先优化再录制
3. **保存优化结果**：将优化后的任务描述作为工作流的描述信息保存

### 功能目标
- 提升用户任务描述的质量和准确性
- 确保任务描述符合Browser-Use最佳实践
- 在录制前自动优化，提升录制成功率
- 提供良好的用户体验和反馈

## 技术选型建议

### 现有技术栈
- **AI服务**：Azure OpenAI (已配置)
- **Web框架**：FastAPI
- **前端**：HTML5 + Bootstrap 5 + Vanilla JavaScript
- **模型交互**：langchain-openai

### 新增依赖
无需新增依赖，基于现有Azure OpenAI配置即可

## 核心架构设计草案

### 1. 任务优化器模块 (`src/core/task_optimizer.py`)
```
TaskOptimizer
├── optimize_task_description()     # 核心优化方法
├── create_azure_openai_client()   # Azure OpenAI客户端创建
├── format_optimization_prompt()   # 格式化提示词
└── validate_optimized_task()      # 验证优化结果
```

### 2. Web API扩展 (`src/web/app.py`)
```
新增API端点：
├── POST /api/tasks/optimize       # 任务描述优化接口
└── 修改 POST /api/recording/start  # 集成优化逻辑
```

### 3. 前端界面增强
```
录制模态框增强：
├── 任务描述输入框
├── 优化按钮
├── 优化结果预览
└── 确认优化结果
```

## 模块/功能划分

### Phase 1: 核心优化模块开发
1. **TaskOptimizer类实现**
   - Azure OpenAI客户端集成
   - 任务优化核心逻辑
   - 错误处理和重试机制

2. **API接口开发**
   - 独立优化接口
   - 集成到录制流程

### Phase 2: 前端界面集成
1. **UI组件开发**
   - 优化按钮和结果展示
   - 加载状态和错误处理
   - 用户确认流程

2. **录制流程修改**
   - 自动优化集成
   - 优化结果保存

### Phase 3: 测试和完善
1. **功能测试**
2. **用户体验优化**
3. **文档更新**

## 初步的API设计

### 1. 任务优化接口

**端点**: `POST /api/tasks/optimize`

**请求体**:
```json
{
  "task_description": "用户输入的原始任务描述",
  "language": "zh"  // 可选，默认中文
}
```

**响应体**:
```json
{
  "success": true,
  "original_task": "原始任务描述",
  "optimized_task": "优化后的任务描述",
  "optimization_time": 1.23,
  "improvements": [
    "更明确的步骤描述",
    "添加了验证条件",
    "优化了输出格式"
  ]
}
```

### 2. 录制接口扩展

**端点**: `POST /api/recording/start` (扩展现有)

**请求体扩展**:
```json
{
  "name": "工作流名称",
  "description": "工作流描述", 
  "task_description": "原始任务描述",
  "auto_optimize": true,  // 新增：是否自动优化
  "mode": "guided",
  "headless": false
}
```

**响应体扩展**:
```json
{
  "message": "录制任务已启动",
  "task_id": "record_xxx",
  "name": "工作流名称",
  "mode": "guided",
  "optimization": {  // 新增：优化信息
    "applied": true,
    "original_task": "原始描述",
    "optimized_task": "优化后描述"
  }
}
```

## 详细的待办事项列表 (Todolist)

### Phase 1: 核心功能开发 ✅
- [x] 1.1 创建 `TaskOptimizer` 类
  - [x] 集成Azure OpenAI配置
  - [x] 实现任务优化核心逻辑
  - [x] 添加错误处理和重试机制
  - [x] 编写测试脚本

- [x] 1.2 扩展Web API
  - [x] 实现独立优化接口 `/api/tasks/optimize`
  - [x] 修改录制接口集成优化逻辑
  - [x] 添加参数验证和错误处理

- [x] 1.3 更新数据模型
  - [x] 扩展 `RecordingRequest` 模型
  - [x] 添加优化相关的响应模型
  - [x] 更新工作流保存逻辑

### Phase 2: 前端界面集成 ✅
- [x] 2.1 优化界面组件
  - [x] 在录制模态框添加"优化任务"按钮
  - [x] 实现优化结果预览组件
  - [x] 添加加载状态和错误提示

- [x] 2.2 JavaScript功能扩展
  - [x] 实现任务优化调用逻辑
  - [x] 更新录制流程集成优化
  - [x] 添加用户确认机制

- [x] 2.3 用户体验优化
  - [x] 添加优化前后对比显示
  - [x] 实现优化建议展示
  - [x] 完善错误处理和用户反馈

### Phase 3: 测试和完善 ✅
- [ ] 3.1 功能测试
  - [ ] 编写API接口测试
  - [ ] 进行端到端测试
  - [ ] 测试各种任务描述场景

- [ ] 3.2 性能和稳定性
  - [ ] 优化响应时间
  - [ ] 添加缓存机制（可选）
  - [ ] 完善错误恢复逻辑

- [ ] 3.3 文档和部署
  - [ ] 更新用户使用文档
  - [ ] 添加功能演示
  - [ ] 更新开发文档

## 系统提示词优化

基于您提供的提示词，我建议进行以下优化：

### 原始提示词分析
您的提示词已经很完善，包含了：
- 明确的角色定义
- 详细的格式要求
- 具体的输出规范
- 实用的示例

### 建议优化点
1. **增加错误处理指导**
2. **优化多语言支持**
3. **加强Browser-Use特定优化**
4. **添加任务复杂度评估**

### 优化后的系统提示词
```
你是「Browser-Use 任务优化器」，专门将用户任务转换为最佳的 Browser-Use 执行格式。

**核心目标**：将 <<USER_TASK>> 优化为单个、清晰、可执行的 Browser-Use task 描述。

**优化规则**：
1. **目标聚焦**：用一句简洁祈使句概括最终目标
2. **步骤明确**：使用编号列出关键操作，逻辑清晰、可执行
3. **输出精确**：明确文件名、格式、字段要求
4. **约束清楚**：列出域名限制、过滤条件、时间约束
5. **验证明确**：说明完成标志和错误处理方案
6. **表达精确**：避免模糊指代，使用具体值
7. **单一原则**：一次一个主目标，复杂任务需拆分说明

**Browser-Use 特性优化**：
- 优先使用可见元素选择器
- 明确等待条件和超时设置
- 指定截图和数据保存要求
- 考虑页面加载和响应时间

**输出要求**：
- 仅输出优化后的 task 字符串
- 不包含任何解释、标记或额外内容
- 使用与用户相同的语言

**质量检查**：
- 任务是否可独立执行？
- 步骤是否逻辑清晰？
- 是否包含必要的验证？
- 错误处理是否充分？

现在开始优化任务。
```

## 设计决策记录

### 1. 为什么选择集成到录制流程？
- **用户体验**：无需额外步骤，自动优化
- **一致性**：确保所有录制都使用优化后的描述
- **效率**：减少用户手动调整的工作量

### 2. 为什么提供独立优化接口？
- **灵活性**：用户可以预览优化结果
- **调试**：便于测试和调试优化效果
- **扩展性**：未来可用于其他场景

### 3. 数据保存策略
- **原始描述**：保留用户原始输入
- **优化描述**：作为工作流主要描述
- **优化信息**：记录优化过程和改进点

## 下一步行动计划

1. **立即开始Phase 1**：创建 `TaskOptimizer` 核心模块
2. **并行开发**：API接口和前端组件可并行开发
3. **迭代测试**：每个功能完成后立即测试
4. **用户反馈**：收集使用反馈持续优化

## 风险评估与应对

### 潜在风险
1. **Azure OpenAI调用失败**
   - 应对：添加重试机制和降级方案
2. **优化结果不满意**
   - 应对：提供手动编辑功能
3. **响应时间过长**
   - 应对：添加超时设置和缓存机制

### 成功指标
- 优化接口响应时间 < 5秒
- 用户满意度 > 80%
- 录制成功率提升 > 20% 